# Last9 Kubernetes Monitoring Values
# Conflict-free configuration using high ports (40000+) to avoid conflicts
# Port allocation:
# - Prometheus: 40002 (instead of 9090)
# - Node Exporter: 40001 (instead of 9100)
# - Kube State Metrics: 40003 (instead of 8080)

# Disable default deployments
alertmanager:
  enabled: false

grafana:
  enabled: false

prometheus:
  enabled: true
  agentMode: true
  # Use high ports to avoid conflicts
  service:
    port: 40002
  prometheusSpec:
    # Enable only necessary scrape configs
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    
    # Configure remote write
    # Global external labels to add to all metrics
    externalLabels:
      cluster: my-cluster-name # Replace with your cluster name

    remoteWrite:
      - url: "{{YOUR_MONITORING_ENDPOINT}}"
        remoteTimeout: 60s
        queueConfig:
          capacity: 10000
          maxSamplesPerSend: 3000
          batchSendDeadline: 20s
          minShards: 4
          maxShards: 200
          minBackoff: 100ms
          maxBackoff: 10s
        basicAuth:
          username:
            name: last9-remote-write-secret
            key: username
          password:
            name: last9-remote-write-secret
            key: password
        writeRelabelConfigs:
          - sourceLabels: [__name__]
            regex: "up|kube_.*|container_.*|node_.*"  # Keep relevant metrics
            action: keep

# Keep kube-state-metrics with high port to avoid conflicts
kubeStateMetrics:
  enabled: true
  service:
    port: 40003

# Keep node-exporter with high port to avoid conflicts
nodeExporter:
  enabled: true
  service:
    port: 40001
    targetPort: 40001
  # Avoid host port binding completely
  hostNetwork: false
  hostPID: true

# Enable cadvisor via kubelet service monitor
kubelet:
  enabled: true
  serviceMonitor:
    resource: true  # Enables scraping of cadvisor metrics
    cAdvisor: true

# Disable unnecessary components
prometheusOperator:
  admissionWebhooks:
    enabled: false
  tls:
    enabled: false

# Disable other exporters
kubeApiServer:
  enabled: true

kubeControllerManager:
  enabled: false

kubeDns:
  enabled: false

kubeEtcd:
  enabled: false

kubeProxy:
  enabled: false

kubeScheduler:
  enabled: false

# Global annotations and labels for conflict resolution
commonAnnotations:
  last9.com/conflict-resolution: "enabled"
  last9.com/high-ports: "40000+"

commonLabels:
  last9.com/conflict-resolution: "enabled"

