# =============================================================================
# Docker Compose with Tail-Based Sampling
# =============================================================================
#
# Complete setup for running Node.js app with OTel Collector.
# The collector performs tail-based sampling before forwarding to Last9.
#
# Usage:
#   # Set credentials
#   export LAST9_OTLP_ENDPOINT=https://otlp.last9.io
#   export LAST9_AUTH_HEADER="Basic YOUR_TOKEN"
#
#   # Start everything
#   docker-compose up -d
#
#   # View logs
#   docker-compose logs -f

services:
  # Node.js Application
  app:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: node14-express
    ports:
      - "3000:3000"
    environment:
      # Send to collector, not directly to Last9
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_SERVICE_NAME=node14-express-example
      - OTEL_RESOURCE_ATTRIBUTES=deployment.environment=docker
      - OTEL_TRACES_SAMPLER=always_on  # Collector handles sampling
      - PORT=3000
    depends_on:
      otel-collector:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - app-network

  # OpenTelemetry Collector with Tail-Based Sampling
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.118.0
    container_name: otel-collector
    command: --config=/etc/otel-collector/config.yaml
    volumes:
      - ../../otel-collector-config.yaml:/etc/otel-collector/config.yaml:ro
    environment:
      - LAST9_OTLP_ENDPOINT=${LAST9_OTLP_ENDPOINT}
      - LAST9_AUTH_HEADER=${LAST9_AUTH_HEADER}
    ports:
      - "4317:4317"   # OTLP gRPC (optional, for external apps)
      - "4318:4318"   # OTLP HTTP (optional, for external apps)
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:13133/"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
