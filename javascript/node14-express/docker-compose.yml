version: '3.8'

# Docker Compose configuration for Node 14 Express with OpenTelemetry
#
# Two modes available:
# 1. Direct export (default): App sends traces directly to Last9
#    docker-compose up app
#
# 2. Tail-based sampling: App -> Collector -> Last9 (intelligent sampling)
#    docker-compose --profile with-collector up

services:
  # Node.js application with OpenTelemetry instrumentation
  app:
    build: .
    container_name: node14-express-otel
    profiles:
      - direct
    ports:
      - "3000:3000"
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_EXPORTER_OTLP_HEADERS=${OTEL_EXPORTER_OTLP_HEADERS}
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-node14-express-example}
      - OTEL_TRACES_SAMPLER=${OTEL_TRACES_SAMPLER:-always_on}
      - OTEL_TRACES_SAMPLER_ARG=${OTEL_TRACES_SAMPLER_ARG:-1.0}
      - OTEL_RESOURCE_ATTRIBUTES=${OTEL_RESOURCE_ATTRIBUTES:-deployment.environment=local}
      - OTEL_LOG_LEVEL=${OTEL_LOG_LEVEL:-error}
      - PORT=3000
    restart: unless-stopped

  # App configured to send to local collector (for tail-based sampling)
  app-with-collector:
    build: .
    container_name: node14-express-otel-sampled
    profiles:
      - with-collector
    ports:
      - "3000:3000"
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_SERVICE_NAME=${OTEL_SERVICE_NAME:-node14-express-example}
      - OTEL_TRACES_SAMPLER=always_on
      - OTEL_RESOURCE_ATTRIBUTES=${OTEL_RESOURCE_ATTRIBUTES:-deployment.environment=local}
      - OTEL_LOG_LEVEL=${OTEL_LOG_LEVEL:-error}
      - PORT=3000
    depends_on:
      - otel-collector
    restart: unless-stopped

  # OpenTelemetry Collector with tail-based sampling
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.118.0
    container_name: otel-collector
    profiles:
      - with-collector
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector/config.yaml
    command: --config=/etc/otel-collector/config.yaml
    environment:
      - LAST9_OTLP_ENDPOINT=${LAST9_OTLP_ENDPOINT}
      - LAST9_AUTH_HEADER=${LAST9_AUTH_HEADER}
    restart: unless-stopped
